<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Turniej siatkówki – wynik + tabele grup (TV Pro, sceny)</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 10px 16px 4px;
      background: #020617;
      border-bottom: 1px solid #1f2937;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
    }

    .small-text {
      font-size: 11px;
      color: #6b7280;
    }

    .sponsors-bar {
      margin-top: 6px;
      padding: 4px 0 2px;
      font-size: 12px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0.9;
    }

    .sponsors-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: #9ca3af;
    }

    .sponsors-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 400px;
    }

    .sponsors-bar.empty .sponsors-name {
      opacity: 0.6;
      font-weight: 400;
    }

    .scene-banner {
      text-align: center;
      padding: 6px 0 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      min-height: 20px;
    }

    body:not(.overlay) #sceneBanner {
      display: none;
    }

    main {
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      gap: 16px;
      padding: 16px;
      flex: 1;
      box-sizing: border-box;
    }

    .scoreboard {
      border-radius: 18px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #111827, #020617);
      padding: 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
    }

    .scoreboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .scoreboard-teams {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
    }

    .team {
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: center;
      align-items: center;
    }

    .team-name {
      font-size: 20px;
      font-weight: 800;
      word-break: break-word;
      letter-spacing: 0.3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .team-sets {
      font-size: 13px;
      color: #9ca3af;
    }

    .score-main {
      text-align: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.9);
      min-width: 140px;
      box-shadow: inset 0 0 12px rgba(15, 23, 42, 0.9);
    }

    .score-main span {
      font-size: 32px;
      font-weight: 800;
      display: inline-block;
      min-width: 42px;
    }

    .score-main .separator {
      font-size: 26px;
      padding: 0 8px;
      opacity: 0.8;
    }

    .set-info {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
    }

    .sets-history {
      margin-top: 4px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      font-size: 12px;
      color: #e5e7eb;
    }

    .set-chip {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      opacity: 0;
      animation: setFadeIn 0.2s ease-out forwards;
    }

    .set-chip .set-label {
      font-weight: 600;
      margin-right: 4px;
    }

    @keyframes scoreFlash {
      0%   { box-shadow: 0 0 0 0 rgba(34,197,94,0.0); background: rgba(15,23,42,0.9); }
      40%  { box-shadow: 0 0 18px 3px rgba(56,170,51,0.85); background: rgba(22,163,74,0.3); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.0); background: rgba(15,23,42,0.9); }
    }

    .score-main.flash {
      animation: scoreFlash 0.35s ease-out;
    }

    @keyframes shake {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    .score-main.shake {
      animation: shake 0.25s ease-out;
    }

    @keyframes setFadeIn {
      from { opacity: 0; transform: translateY(3px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .serve-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      background: transparent;
      box-shadow: none;
      transition: 0.2s ease;
    }

    .serve-indicator.active {
      background: #ffffff;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.9);
    }

    .team-name.serving span.name-text {
      border-bottom: 3px solid #38aa33;
      padding-bottom: 2px;
    }

    /* --- TABELKI GRUPOWE --- */
    .standings {
      border-radius: 18px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
    }

    .standings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .standings-header h2 {
      font-size: 16px;
      margin: 0;
    }

    .standings-groups {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .standings-group {
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      background: #020617;
    }

    .standings-group-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0 0 4px;
      color: #e5e7eb;
    }

    .standings-group table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    th, td {
      padding: 4px 6px;
      text-align: center;
    }

    th {
      background: #111827;
      color: #9ca3af;
      font-weight: 500;
      border-bottom: 1px solid #1f2937;
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tbody tr:nth-child(odd) {
      background: #030712;
    }

    tbody tr:first-child {
      outline: 1px solid #38aa33;
      outline-offset: -1px;
    }

    td {
      border-bottom: 1px solid #111827;
    }

    td.team-name-cell {
      text-align: left;
      font-weight: 500;
    }

    .break-results-panel {
      border-radius: 18px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 16px;
      display: none;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
      font-size: 13px;
    }

    .break-results-panel h2 {
      margin: 0;
      font-size: 16px;
    }

    .break-results {
      margin-top: 8px;
      font-size: 12px;
      color: #e5e7eb;
      max-height: 220px;
      overflow-y: auto;
    }

    .break-results-item {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
    }

    .break-results-item span {
      white-space: nowrap;
    }

    .controls {
      grid-column: 1 / span 2;
      border-top: 1px solid #1f2937;
      padding: 12px 16px 16px;
      background: #020617;
      display: grid;
      grid-template-columns: 2fr 2fr 1.6fr 1.6fr;
      gap: 12px;
      font-size: 13px;
    }

    .controls-section {
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #020617;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
    }

    .controls-section h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: #9ca3af;
    }

    select, input[type="number"], input[type="text"] {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }

    button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    button:hover {
      background: #1f2937;
    }

    button.primary {
      border-color: #38aa33;
    }

    button.primary:hover {
      background: #15803d;
    }

    button.danger {
      border-color: #ef4444;
    }

    button.danger:hover {
      background: #991b1b;
    }

    .score-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .score-buttons-group {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .row > * {
      flex: 1;
      min-width: 100px;
    }

    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      max-height: 90px;
      overflow-y: auto;
    }

    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
    }

    .pill:hover {
      border-color: #ef4444;
      background: #111827;
    }

    /* ---------- OVERLAY (OBS) ---------- */

    body.overlay {
      background: #020617;
    }

    body.overlay header {
      padding: 8px 24px 0;
      background: #020617;
      border-bottom: none;
    }

    body.overlay .header-top h1,
    body.overlay .header-hint,
    body.overlay .sponsors-bar {
      display: none;
    }

    body.overlay main {
      max-width: 1800px;
      height: calc(100vh - 8px);
      margin: 0 auto;
      padding: 8px 24px 24px;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: 2fr 1fr;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
    }

    body.overlay .scoreboard {
      grid-column: 1 / span 2;
      grid-row: 1;
      width: 1100px;
      margin: 0 auto;
      padding: 10px 28px;
      border-radius: 20px;
      background: radial-gradient(circle at top, #111827, #020617 70%);
      border: 1px solid #1f2937;
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    body.overlay .scoreboard-header {
      font-size: 12px;
    }

    body.overlay .team-name {
      font-size: 22px;
    }

    body.overlay .score-main span {
      font-size: 34px;
    }

    body.overlay .set-info {
      display: none;
    }

    body.overlay .standings {
      grid-column: 2;
      grid-row: 2;
      max-height: 65vh;
      background: rgba(2, 6, 23, 0.98);
      overflow: hidden;
      font-size: 12px;
    }

    body.overlay .standings-group table {
      font-size: 11px;
    }

    body.overlay .controls {
      display: none;
    }

    .overlay-logos-row {
      display: none;
    }

    body.overlay .overlay-logos-row {
      display: flex;
      grid-column: 2;
      grid-row: 3;
      align-self: start;
      justify-self: center;
      width: 100%;
      gap: 12px;
    }

    .overlay-logo-box {
      flex: 1;
      height: 125px;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      padding: 10px 18px;
      box-sizing: border-box;
      align-items: center;
      justify-content: center;
      display: flex;
    }

    .overlay-logo-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      gap: 6px;
    }

    .overlay-logo-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #111827;
      text-align: center;
    }

    .overlay-logo-box img {
      max-width: 100%;
      max-height: 70%;
      object-fit: contain;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .scene-overlay-message {
      display: none;
      position: absolute;
      left: 50%;
      top: 55%;
      transform: translate(-50%, -50%);
      text-align: center;
      font-size: 32px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #e5e7eb;
      text-shadow: 0 8px 20px rgba(0,0,0,0.8);
      pointer-events: none;
      padding: 8px 16px;
    }

    body.overlay[data-scene="technical"] .scene-overlay-message {
      display: block;
    }

    @media (max-width: 1300px) {
      .controls {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    @media (max-width: 1000px) {
      .controls {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
      .controls {
        grid-template-columns: 1fr;
      }
    }

    /* ---------- SCENY ---------- */

    body.overlay[data-scene="break"] .scoreboard {
      display: none;
    }
    body.overlay[data-scene="break"] main {
      grid-template-columns: 1.2fr 1.8fr;
      grid-template-rows: auto 1fr auto;
    }
    body.overlay[data-scene="break"] .break-results-panel {
      display: flex;
      grid-column: 1;
      grid-row: 2;
    }
    body.overlay[data-scene="break"] .standings {
      display: flex;
      grid-column: 2;
      grid-row: 2;
      max-height: none;
    }
    body.overlay[data-scene="break"] .overlay-logos-row {
      grid-column: 1 / span 2;
      grid-row: 3;
      justify-content: center;
      margin-top: 24px;
    }
    body.overlay[data-scene="break"] .break-results-panel,
    body.overlay[data-scene="break"] .standings {
      height: 100%;
      max-height: none;
      align-self: stretch;
    }

    body.overlay[data-scene="final"] .standings,
    body.overlay[data-scene="final"] .break-results-panel {
      display: none;
    }
    body.overlay[data-scene="final"] .overlay-logos-row {
      grid-column: 1 / span 2;
      grid-row: 3;
      justify-content: center;
    }
    body.overlay[data-scene="final"] .scoreboard {
      grid-column: 1 / span 2;
      grid-row: 2;
      margin-top: 40px;
      width: 900px;
    }
    body.overlay[data-scene="final"] .scoreboard-header {
      justify-content: center;
    }
    body.overlay[data-scene="final"] .sets-history {
      margin-top: 12px;
    }
    body.overlay[data-scene="final"] .set-chip {
      font-size: 16px;
      padding: 6px 12px;
    }

    body.overlay[data-scene="technical"] main {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr auto;
    }
    body.overlay[data-scene="technical"] .scoreboard,
    body.overlay[data-scene="technical"] .standings,
    body.overlay[data-scene="technical"] .break-results-panel {
      display: none;
    }
    body.overlay[data-scene="technical"] .overlay-logos-row {
      grid-column: 1;
      grid-row: 2;
      justify-content: center;
      width: 1100px;
      max-width: 1100px;
      margin: 0 auto 40px;
    }

    body.overlay[data-scene="break"] .overlay-logos-row,
    body.overlay[data-scene="final"] .overlay-logos-row,
    body.overlay[data-scene="technical"] .overlay-logos-row {
      max-width: 1100px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>Turniej siatkówki – wynik & tabele grup</h1>
      <div class="small-text header-hint">
        Podgląd do transmisji: przechwytuj okno przeglądarki (OBS).
      </div>
    </div>
    <div class="sponsors-bar empty" id="sponsorsBar">
      <span class="sponsors-label">Sponsor:</span>
      <span class="sponsors-name">Brak sponsorów – dodaj w panelu</span>
    </div>
  </header>

  <div id="sceneBanner" class="scene-banner"></div>

  <main>
    <!-- SCOREBOARD -->
    <section class="scoreboard">
      <div class="scoreboard-header">
        <div>Mecz: <span id="matchLabel">–</span></div>
        <div>Set: <span id="currentSet">1</span> (gramy do 2 wygranych setów)</div>
      </div>

      <div class="scoreboard-teams">
        <div class="team">
          <div class="team-name" id="teamANameBox">
            <span class="serve-indicator" id="serveA"></span>
            <span class="name-text" id="teamAName">Drużyna A</span>
          </div>
          <div class="team-sets">Sety: <span id="teamASets">0</span></div>
        </div>

        <div class="score-main" id="scoreMain">
          <span id="teamAPoints">0</span>
          <span class="separator">:</span>
          <span id="teamBPoints">0</span>
        </div>

        <div class="team">
          <div class="team-name" id="teamBNameBox">
            <span class="serve-indicator" id="serveB"></span>
            <span class="name-text" id="teamBName">Drużyna B</span>
          </div>
          <div class="team-sets">Sety: <span id="teamBSets">0</span></div>
        </div>
      </div>

      <div class="sets-history" id="setsHistory"></div>

      <div class="set-info">
        Aktualny set – punkty na żywo. Po zakończeniu seta użyj przycisku „Zakończ seta”.
      </div>
    </section>

    <!-- PANEL WYNIKÓW – PRZERWA -->
    <section class="break-results-panel" id="breakResultsPanel">
      <h2>Wyniki meczów</h2>
      <div class="break-results" id="breakResults"></div>
    </section>

    <!-- TABELKI GRUPOWE -->
    <section class="standings">
      <div class="standings-header">
        <h2>Tabele grupowe</h2>
        <span class="small-text">
          Punktacja: 2:0 → 3 pkt, 2:1 → 2 pkt, 1:2 → 1 pkt, 0:2 → 0 pkt
        </span>
      </div>

      <div class="standings-groups">
        <div class="standings-group">
          <p class="standings-group-title">Grupa A</p>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Drużyna</th>
                <th>M</th>
                <th>W</th>
                <th>P</th>
                <th>Sety +</th>
                <th>Sety –</th>
                <th>Pkt +</th>
                <th>Pkt –</th>
                <th>Punkty</th>
              </tr>
            </thead>
            <tbody id="standingsBodyA"></tbody>
          </table>
        </div>

        <div class="standings-group">
          <p class="standings-group-title">Grupa B</p>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Drużyna</th>
                <th>M</th>
                <th>W</th>
                <th>P</th>
                <th>Sety +</th>
                <th>Sety –</th>
                <th>Pkt +</th>
                <th>Pkt –</th>
                <th>Punkty</th>
              </tr>
            </thead>
            <tbody id="standingsBodyB"></tbody>
          </table>
        </div>

        <div class="standings-group">
          <p class="standings-group-title">Grupa C</p>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Drużyna</th>
                <th>M</th>
                <th>W</th>
                <th>P</th>
                <th>Sety +</th>
                <th>Sety –</th>
                <th>Pkt +</th>
                <th>Pkt –</th>
                <th>Punkty</th>
              </tr>
            </thead>
            <tbody id="standingsBodyC"></tbody>
          </table>
        </div>

        <div class="standings-group">
          <p class="standings-group-title">Grupa D</p>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Drużyna</th>
                <th>M</th>
                <th>W</th>
                <th>P</th>
                <th>Sety +</th>
                <th>Sety –</th>
                <th>Pkt +</th>
                <th>Pkt –</th>
                <th>Punkty</th>
              </tr>
            </thead>
            <tbody id="standingsBodyD"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BOXY Z LOGO -->
    <div class="overlay-logos-row">
      <div class="overlay-logo-box" id="sponsorsBox">
        <div class="overlay-logo-inner">
          <div class="overlay-logo-label">Sponsorzy i partnerzy</div>
          <img id="overlayLogo" alt="Sponsor / partner" />
        </div>
      </div>
      <div class="overlay-logo-box" id="organizersBox">
        <div class="overlay-logo-inner">
          <div class="overlay-logo-label">Organizatorzy wydarzenia</div>
          <img id="overlayOrganizerLogo" alt="Organizator wydarzenia" />
        </div>
      </div>
    </div>

    <div id="sceneOverlayMessage" class="scene-overlay-message"></div>

    <!-- PANEL STEROWANIA -->
    <section class="controls">
      <!-- WYBÓR MECZU -->
      <div class="controls-section">
        <h3>Mecz – wybór drużyn</h3>
        <div class="row">
          <label>
            Drużyna A (gospodarz)
            <select id="teamASelect"></select>
          </label>
          <label>
            Drużyna B (gość)
            <select id="teamBSelect"></select>
          </label>
        </div>
        <div class="row">
          <button id="startMatchBtn" class="primary">Rozpocznij / zresetuj mecz</button>
          <button id="swapTeamsBtn">Zamień strony</button>
        </div>
        <div class="small-text">
          Zmieniasz drużyny i klikasz „Rozpocznij / zresetuj mecz”, gdy zaczyna się nowy mecz.
        </div>
      </div>

      <!-- PUNKTY NA ŻYWO -->
      <div class="controls-section">
        <h3>Punkty – aktualny set</h3>
        <div class="score-buttons">
          <div class="score-buttons-group">
            <button data-action="addPointA">+1 A</button>
            <button data-action="subPointA">-1 A</button>
          </div>
          <div class="score-buttons-group">
            <button data-action="addPointB">+1 B</button>
            <button data-action="subPointB">-1 B</button>
          </div>
        </div>
        <div class="row">
          <button id="endSetABtn" class="primary">Zakończ seta – wygrała A</button>
          <button id="endSetBBtn" class="primary">Zakończ seta – wygrała B</button>
        </div>
        <div class="row">
          <button id="resetSetBtn">Wyzeruj aktualny set</button>
        </div>
        <div class="small-text">
          Po zakończeniu seta wybierz zwycięzcę seta. Aplikacja doliczy sety i przejdzie do kolejnego.
        </div>
      </div>
      
      <!-- TABELA / RESET -->
      <div class="controls-section">
        <h3>Zakończenie meczu / tabela</h3>
        <div class="small-text">
          Gdy mecz się skończy (2:0 lub 2:1 w setach), zatwierdź wynik do tabeli.
        </div>
        <div class="row">
          <button id="finishMatchABtn" class="primary">Mecz wygrała A</button>
          <button id="finishMatchBBtn" class="primary">Mecz wygrała B</button>
        </div>
        <div class="row">
          <button id="resetTournamentBtn" class="danger">Wyczyść całą tabelę</button>
        </div>
      </div>

      <!-- DRUŻYNY -->
      <div class="controls-section">
        <h3>Drużyny – zarządzanie</h3>
        <div class="row">
          <label>
            Wybierz drużynę do edycji
            <select id="editTeamSelect"></select>
          </label>
          <label>
            Nowa nazwa
            <input id="editTeamNameInput" type="text" placeholder="Nowa nazwa drużyny" />
          </label>
        </div>
        <div class="row">
          <button id="saveTeamNameBtn" class="primary">Zapisz nazwę</button>
        </div>
        <div class="row">
          <label>
            Dodaj nową drużynę
            <input id="newTeamNameInput" type="text" placeholder="Nazwa nowej drużyny" />
          </label>
          <button id="addTeamBtn">Dodaj drużynę</button>
        </div>
        <div class="small-text">
          Nazwy i lista drużyn zapisują się automatycznie (localStorage). Reset turnieju czyści tylko wyniki.
        </div>
      </div>

      <!-- SPONSORZY (tekst w nagłówku) -->
      <div class="controls-section">
        <h3>Sponsorzy turnieju (tekst w nagłówku)</h3>
        <div class="row">
          <label>
            Dodaj sponsora
            <input id="newSponsorNameInput" type="text" placeholder="Nazwa sponsora" />
          </label>
          <button id="addSponsorBtn">Dodaj</button>
        </div>
        <div>
          <div class="small-text">
            Lista sponsorów (kliknij w nazwę, aby usunąć z listy):
          </div>
          <div id="sponsorsList" class="pill-list"></div>
        </div>
        <div class="small-text">
          Pasek sponsorów w nagłówku obraca się automatycznie co 5 sekund (tekst).
        </div>
      </div>

      <!-- DODAJ MECZ RĘCZNIE – SET PO SECIE -->
      <div class="controls-section">
        <h3>Dodaj mecz ręcznie (set po secie)</h3>
        <div class="small-text">
          Użyj tego, gdy chcesz wpisać wynik zakończonego meczu bez klikania punktów na żywo.
        </div>

        <div class="row">
          <label>
            Drużyna A
            <select id="manualTeamA"></select>
          </label>
          <label>
            Drużyna B
            <select id="manualTeamB"></select>
          </label>
        </div>

        <div class="row">
          <label>
            Set 1 – A
            <input id="manualSet1A" type="number" min="0" />
          </label>
          <label>
            Set 1 – B
            <input id="manualSet1B" type="number" min="0" />
          </label>
        </div>

        <div class="row">
          <label>
            Set 2 – A
            <input id="manualSet2A" type="number" min="0" />
          </label>
          <label>
            Set 2 – B
            <input id="manualSet2B" type="number" min="0" />
          </label>
        </div>

        <div class="row">
          <label>
            Set 3 – A (opcjonalnie)
            <input id="manualSet3A" type="number" min="0" />
          </label>
          <label>
            Set 3 – B (opcjonalnie)
            <input id="manualSet3B" type="number" min="0" />
          </label>
        </div>

        <div class="row">
          <label>
            Etap meczu
            <select id="manualStage">
              <option value="group">Faza grupowa</option>
              <option value="quarterfinal">Ćwierćfinał</option>
              <option value="semifinal">Półfinał</option>
              <option value="thirdplace">Mecz o 3. miejsce</option>
              <option value="final">Finał</option>
              <option value="other">Inny</option>
            </select>
          </label>
        </div>

        <div class="row">
          <button id="addManualMatchBtn" class="primary">Dodaj mecz do tabeli</button>
        </div>

        <div class="small-text">
          Wpisz pełny wynik setów (2 albo 3 sety). System sam policzy sety, małe punkty i punkty do tabeli.
        </div>
      </div>

      <!-- SCENY -->
      <div class="controls-section">
        <h3>Scena overlayu</h3>
        <label>
          Aktywna scena
          <select id="sceneSelect">
            <option value="game">Mecz – na żywo</option>
            <option value="break">Przerwa – tabela i wyniki</option>
            <option value="final">Koniec meczu – wynik końcowy</option>
            <option value="technical">Plansza techniczna „zaraz wracamy”</option>
          </select>
        </label>
        <button id="applySceneBtn" class="primary">Ustaw scenę</button>
        <div class="small-text">
          Scena przełączy się również w oknie overlayu (OBS).
        </div>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = "volley_tournament_state_v1";
    const LOGO_MAX_INDEX = 20;
    const LOGO_ROTATION_MS = 5000;
    const ORGANIZER_ROTATION_MS = 7000;

    const initialTeams = [
      { name: "Asy Mikasy", group: "A" },
      { name: "Tartak Siemianówka", group: "A" },
      { name: "SGA Trans-Ber", group: "A" },
      { name: "Rojal Flasz", group: "B" },
      { name: "Meridan Team", group: "B" },
      { name: "Torpeda Białystok", group: "B" },
      { name: "Sparta Łosice", group: "C" },
      { name: "Golden Crew", group: "C" },
      { name: "MR Energy", group: "C" },
      { name: "Global East", group: "D" },
      { name: "KZS Białystok", group: "D" },
      { name: "Kometa", group: "D" }
    ];
    const ORGANIZER_LOGOS = ["MR Energy.png", "Tytani.png"];
    const SCENES = ["game", "break", "final", "technical"];
    
    function getMinPointsForSet(setNumber) {
      if (setNumber === 3) return 15;
      return 25;
    }

    function getViewMode() {
      try {
        const params = new URLSearchParams(window.location.search);
        return params.get("view") || "";
      } catch {
        return "";
      }
    }
    const viewMode = getViewMode();
    if (viewMode === "overlay") document.body.classList.add("overlay");

    let teams = [];
    let matchesHistory = [];
    let sponsors = [];
    let sponsorsRotationIndex = 0;
    let sponsorsRotationTimer = null;

    let currentMatch = createEmptyMatch();
    let lastPointWinner = null;
    let currentScene = "game";

    let logoFiles = [];
    let logosRotationIndex = 0;
    let logosRotationTimer = null;

    let organizerFiles = [];
    let organizerIndex = 0;
    let organizerTimer = null;

    function createEmptyMatch() {
      return {
        teamAId: null,
        teamBId: null,
        setA: 0,
        setB: 0,
        pointsA: 0,
        pointsB: 0,
        currentSet: 1,
        setsHistory: []
      };
    }

    function initTeams() {
      teams = initialTeams.map((entry, index) => {
        const name = typeof entry === "string" ? entry : entry.name;
        const group = typeof entry === "string" ? "" : (entry.group || "");
        return {
          id: index,
          name,
          played: 0,
          won: 0,
          lost: 0,
          setsWon: 0,
          setsLost: 0,
          pointsFor: 0,
          pointsAgainst: 0,
          tablePoints: 0,
          group
        };
      });
    }

    function resetTeamsStatsOnly() {
      teams.forEach(t => {
        t.played = 0;
        t.won = 0;
        t.lost = 0;
        t.setsWon = 0;
        t.setsLost = 0;
        t.pointsFor = 0;
        t.pointsAgainst = 0;
        t.tablePoints = 0;
      });
    }

    function saveState() {
      try {
        const data = {
          teams,
          matchesHistory,
          currentMatch,
          sponsors,
          lastPointWinner,
          currentScene
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("Nie udało się zapisać stanu:", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed.teams)) return false;

        teams = parsed.teams;
        matchesHistory = Array.isArray(parsed.matchesHistory) ? parsed.matchesHistory : [];
        currentMatch = parsed.currentMatch || createEmptyMatch();
        sponsors = Array.isArray(parsed.sponsors) ? parsed.sponsors : [];
        lastPointWinner = parsed.lastPointWinner || null;
        currentScene = parsed.currentScene || "game";
        return true;
      } catch (e) {
        console.warn("Problem z odczytem stanu:", e);
        return false;
      }
    }

    function renderSponsorsBar() {
      const bar = document.getElementById("sponsorsBar");
      if (!bar) return;
      const nameEl = bar.querySelector(".sponsors-name");

      if (!sponsors || sponsors.length === 0) {
        bar.classList.add("empty");
        if (nameEl) nameEl.textContent = "Brak sponsorów – dodaj w panelu";
        return;
      }

      bar.classList.remove("empty");
      if (sponsorsRotationIndex >= sponsors.length) sponsorsRotationIndex = 0;
      const sponsor = sponsors[sponsorsRotationIndex];
      if (nameEl) nameEl.textContent = sponsor.name;
    }

    function startSponsorsRotation() {
      if (sponsorsRotationTimer) clearInterval(sponsorsRotationTimer);
      renderSponsorsBar();
      if (!sponsors || sponsors.length === 0) return;
      sponsorsRotationTimer = setInterval(() => {
        sponsorsRotationIndex = (sponsorsRotationIndex + 1) % sponsors.length;
        renderSponsorsBar();
      }, 5000);
    }

    function renderSponsorsList() {
      const container = document.getElementById("sponsorsList");
      if (!container) return;
      container.innerHTML = "";
      sponsors.forEach(s => {
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = s.name;
        pill.title = "Kliknij w nazwę, aby usunąć";
        pill.addEventListener("click", () => {
          if (confirm(`Usunąć sponsora "${s.name}" z listy?`)) {
            sponsors = sponsors.filter(x => x.id !== s.id);
            sponsorsRotationIndex = 0;
            renderSponsorsList();
            startSponsorsRotation();
            saveState();
          }
        });
        container.appendChild(pill);
      });
    }

    function getNextSponsorId() {
      if (!sponsors || sponsors.length === 0) return 0;
      return Math.max(...sponsors.map(s => s.id)) + 1;
    }

    function addSponsor() {
      const input = document.getElementById("newSponsorNameInput");
      if (!input) return;
      const name = input.value.trim();
      if (!name) {
        alert("Podaj nazwę sponsora.");
        return;
      }
      const id = getNextSponsorId();
      sponsors.push({ id, name });
      input.value = "";
      sponsorsRotationIndex = 0;
      renderSponsorsList();
      startSponsorsRotation();
      saveState();
    }

    function detectLogoFiles(callback) {
      logoFiles = [];
      let remaining = LOGO_MAX_INDEX;
      if (remaining === 0) { if (callback) callback(); return; }

      for (let i = 1; i <= LOGO_MAX_INDEX; i++) {
        const src = `logo${i}.png`;
        const img = new Image();
        img.onload = () => { logoFiles.push(src); checkDone(); };
        img.onerror = () => { checkDone(); };
        img.src = src;
      }
      function checkDone() {
        remaining--;
        if (remaining === 0 && callback) callback();
      }
    }

    function startOverlayLogoRotation() {
      const imgEl = document.getElementById("overlayLogo");
      if (!imgEl) return;
      if (!logoFiles || logoFiles.length === 0) {
        imgEl.style.opacity = 0;
        return;
      }
      if (logosRotationTimer) clearInterval(logosRotationTimer);

      const showNext = () => {
        imgEl.style.opacity = 0;
        const src = logoFiles[logosRotationIndex];
        logosRotationIndex = (logosRotationIndex + 1) % logoFiles.length;
        setTimeout(() => {
          imgEl.src = src;
          imgEl.onload = () => { imgEl.style.opacity = 1; };
        }, 200);
      };
      showNext();
      logosRotationTimer = setInterval(showNext, LOGO_ROTATION_MS);
    }

    function detectOrganizerFiles(callback) {
      organizerFiles = [];
      let remaining = ORGANIZER_LOGOS.length;
      if (remaining === 0) { if (callback) callback(); return; }

      ORGANIZER_LOGOS.forEach(src => {
        const img = new Image();
        img.onload = () => { organizerFiles.push(src); checkDone(); };
        img.onerror = () => { checkDone(); };
        img.src = src;
      });
      function checkDone() {
        remaining--;
        if (remaining === 0 && callback) callback();
      }
    }

    function startOrganizerRotation() {
      const imgEl = document.getElementById("overlayOrganizerLogo");
      if (!imgEl) return;
      if (!organizerFiles || organizerFiles.length === 0) {
        imgEl.style.opacity = 0;
        return;
      }
      if (organizerTimer) clearInterval(organizerTimer);

      const showNext = () => {
        imgEl.style.opacity = 0;
        const src = organizerFiles[organizerIndex];
        organizerIndex = (organizerIndex + 1) % organizerFiles.length;
        setTimeout(() => {
          imgEl.src = src;
          imgEl.onload = () => { imgEl.style.opacity = 1; };
        }, 200);
      };
      showNext();
      organizerTimer = setInterval(showNext, ORGANIZER_ROTATION_MS);
    }

    function applySceneToDOM() {
      if (document.body.classList.contains("overlay")) {
        document.body.setAttribute("data-scene", currentScene);
      }
      const sceneSelect = document.getElementById("sceneSelect");
      if (sceneSelect) sceneSelect.value = currentScene;

      const banner = document.getElementById("sceneBanner");
      if (banner) {
        let text = "";
        switch (currentScene) {
          case "break": text = "Aktualna tabela i wyniki meczów"; break;
          case "final": text = "Koniec meczu – wynik końcowy"; break;
          case "technical": text = "Przerwa techniczna – zaraz wracamy"; break;
          default: text = "";
        }
        banner.textContent = text;
      }

      const msgEl = document.getElementById("sceneOverlayMessage");
      if (msgEl) {
        msgEl.textContent = currentScene === "technical"
          ? "Przerwa techniczna – zaraz wracamy"
          : "";
      }
    }

    function setScene(scene) {
      if (!SCENES.includes(scene)) return;
      currentScene = scene;
      applySceneToDOM();
      saveState();
    }

    function populateTeamSelects() {
      const teamASelect = document.getElementById("teamASelect");
      const teamBSelect = document.getElementById("teamBSelect");
      const editTeamSelect = document.getElementById("editTeamSelect");
      const manualTeamA = document.getElementById("manualTeamA");
      const manualTeamB = document.getElementById("manualTeamB");

      if (teamASelect && teamBSelect) {
        teamASelect.innerHTML = "";
        teamBSelect.innerHTML = "";
        teams.forEach(team => {
          const optionA = document.createElement("option");
          optionA.value = team.id;
          optionA.textContent = team.name;
          teamASelect.appendChild(optionA);

          const optionB = document.createElement("option");
          optionB.value = team.id;
          optionB.textContent = team.name;
          teamBSelect.appendChild(optionB);
        });

        if (teams.length >= 2) {
          if (currentMatch.teamAId == null || currentMatch.teamBId == null) {
            teamASelect.value = teams[0].id;
            teamBSelect.value = teams[1].id;
          } else {
            teamASelect.value = currentMatch.teamAId;
            teamBSelect.value = currentMatch.teamBId;
          }
        }
      }

      if (editTeamSelect) {
        editTeamSelect.innerHTML = "";
        teams.forEach(team => {
          const opt = document.createElement("option");
          opt.value = team.id;
          opt.textContent = team.name;
          editTeamSelect.appendChild(opt);
        });
      }

      if (manualTeamA && manualTeamB) {
        manualTeamA.innerHTML = "";
        manualTeamB.innerHTML = "";
        teams.forEach(team => {
          const optA = document.createElement("option");
          optA.value = team.id;
          optA.textContent = team.name;
          manualTeamA.appendChild(optA);

          const optB = document.createElement("option");
          optB.value = team.id;
          optB.textContent = team.name;
          manualTeamB.appendChild(optB);
        });
      }
    }

    function startOrResetMatch() {
      const teamASelect = document.getElementById("teamASelect");
      const teamBSelect = document.getElementById("teamBSelect");
      if (!teamASelect || !teamBSelect) return;

      const teamAId = parseInt(teamASelect.value, 10);
      const teamBId = parseInt(teamBSelect.value, 10);
      if (teamAId === teamBId) {
        highlightScoreError("Wybierz dwie różne drużyny.");
        return;
      }

      currentMatch.teamAId = teamAId;
      currentMatch.teamBId = teamBId;
      currentMatch.setA = 0;
      currentMatch.setB = 0;
      currentMatch.pointsA = 0;
      currentMatch.pointsB = 0;
      currentMatch.currentSet = 1;
      currentMatch.setsHistory = [];
      lastPointWinner = null;

      renderScoreboard();
      saveState();
      updateControlsAvailability();
      updateControlsAvailability();
    }

    function swapTeams() {
      const teamASelect = document.getElementById("teamASelect");
      const teamBSelect = document.getElementById("teamBSelect");
      if (!teamASelect || !teamBSelect) return;
      const oldA = teamASelect.value;
      teamASelect.value = teamBSelect.value;
      teamBSelect.value = oldA;
      startOrResetMatch();
    }

    function addTemporaryClass(el, className, duration = 300) {
      if (!el) return;
      el.classList.remove(className);
      void el.offsetWidth;
      el.classList.add(className);
      setTimeout(() => el.classList.remove(className), duration);
    }

    function flashScore() {
      const scoreEl = document.getElementById("scoreMain");
      addTemporaryClass(scoreEl, "flash", 350);
    }

    function highlightScoreError(message) {
      if (message) alert(message);
      const scoreEl = document.getElementById("scoreMain");
      addTemporaryClass(scoreEl, "shake", 280);
    }

    function isMatchComplete(match) {
      return match && (match.setA >= 2 || match.setB >= 2);
    }

    function setControlsDisabled(ids, disabled) {
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = disabled;
      });
      document.querySelectorAll('button[data-action]').forEach(btn => {
        btn.disabled = disabled;
      });
    }

    function updateControlsAvailability() {
      const complete = isMatchComplete(currentMatch);
      // gdy mecz skończony: blokuj punktowanie i kończenie setów; zostaw reset / start nowego meczu
      setControlsDisabled(["endSetABtn", "endSetBBtn", "resetSetBtn"], complete);

      // finish buttons: sensowne dopiero gdy ktoś ma 2 sety
      const finishA = document.getElementById("finishMatchABtn");
      const finishB = document.getElementById("finishMatchBBtn");
      if (finishA) finishA.disabled = !complete;
      if (finishB) finishB.disabled = !complete;
    }

    function updatePoints(team, delta) {
      if (isMatchComplete(currentMatch)) {
        highlightScoreError('Mecz jest już zakończony w setach – zatwierdź wynik (Zakończ mecz) albo rozpocznij nowy.');
        return;
      }

      if (team === "A") {
        if (delta > 0) lastPointWinner = "A";
        currentMatch.pointsA = Math.max(0, currentMatch.pointsA + delta);
      } else {
        if (delta > 0) lastPointWinner = "B";
        currentMatch.pointsB = Math.max(0, currentMatch.pointsB + delta);
      }

      renderScoreboard();
      flashScore();

      // Auto-end set when minimum points are reached WITH 2-point lead
      // Set 1-2: 25+, Set 3: 15+, always min 2 points difference
      const minPoints = getMinPointsForSet(currentMatch.currentSet);
      const a = currentMatch.pointsA;
      const b = currentMatch.pointsB;

      const autoWinner =
        (a >= minPoints && (a - b) >= 2) ? "A" :
        (b >= minPoints && (b - a) >= 2) ? "B" :
        null;

      if (autoWinner) {
        // endSet() will validate again, update UI and save state (and may show confirm if match ends)
        endSet(autoWinner);
        return;
      }

      saveState();
    }

    function endSet(winner) {
      if (isMatchComplete(currentMatch)) {
        highlightScoreError('Mecz jest już zakończony w setach – zatwierdź wynik (Zakończ mecz).');
        return;
      }
      if (currentMatch.currentSet > 3) {
        highlightScoreError('Nie można grać więcej niż 3 sety.');
        return;
      }
      if (currentMatch.teamAId === null || currentMatch.teamBId === null) {
        highlightScoreError("Najpierw rozpocznij mecz.");
        return;
      }

      const a = currentMatch.pointsA;
      const b = currentMatch.pointsB;
      const winnerPoints = winner === "A" ? a : b;
      const loserPoints  = winner === "A" ? b : a;

      const minPoints = getMinPointsForSet(currentMatch.currentSet);

      if (winnerPoints < minPoints) {
        highlightScoreError(
          "Set nie może się zakończyć – w tym secie zwycięzca musi mieć co najmniej " + minPoints + " punktów."
        );
        return;
      }
      if (winnerPoints - loserPoints < 2) {
        highlightScoreError("Set nie może się zakończyć – zwycięzca musi mieć przynajmniej 2 punkty przewagi.");
        return;
      }

      currentMatch.setsHistory.push({
        number: currentMatch.currentSet,
        a: currentMatch.pointsA,
        b: currentMatch.pointsB
      });

      if (winner === "A") {
        currentMatch.setA += 1;
        lastPointWinner = "A";
      } else {
        currentMatch.setB += 1;
        lastPointWinner = "B";
      }

      currentMatch.currentSet += 1;
      currentMatch.pointsA = 0;
      currentMatch.pointsB = 0;

      renderScoreboard();
      updateControlsAvailability();

      // Auto-confirm popup when someone wins 2 sets (stage=group)
      if (isMatchComplete(currentMatch)) {
        const teamA = teams.find(t => t.id === currentMatch.teamAId);
        const teamB = teams.find(t => t.id === currentMatch.teamBId);
        const winner = currentMatch.setA > currentMatch.setB ? "A" : "B";
        const winnerName = winner === "A" ? (teamA?.name || "Drużyna A") : (teamB?.name || "Drużyna B");
        const loserName  = winner === "A" ? (teamB?.name || "Drużyna B") : (teamA?.name || "Drużyna A");
        const ok = confirm(`Mecz zakończony: ${winnerName} vs ${loserName} (${currentMatch.setA}:${currentMatch.setB}).\n\nZatwierdzić wynik do tabeli grupowej?`);
        if (ok) {
          finishMatch(winner);
          return; // finishMatch robi saveState/render, więc kończymy endSet
        } else {
          alert("Wynik nie został zatwierdzony. Kliknij „Zakończ mecz” (A/B), aby dopisać go do tabeli.");
        }
      }

      saveState();
    }

    function resetCurrentSet() {
      currentMatch.pointsA = 0;
      currentMatch.pointsB = 0;
      renderScoreboard();
      saveState();
    }

    function finishMatch(winner) {
      if (currentMatch.teamAId === null || currentMatch.teamBId === null) {
        highlightScoreError("Najpierw rozpocznij mecz.");
        return;
      }

      const setsA = currentMatch.setA;
      const setsB = currentMatch.setB;

      if (winner === "A" && setsA < 2) {
        highlightScoreError("Mecz nie może być zakończony – drużyna A nie ma jeszcze 2 wygranych setów.");
        return;
      }
      if (winner === "B" && setsB < 2) {
        highlightScoreError("Mecz nie może być zakończony – drużyna B nie ma jeszcze 2 wygranych setów.");
        return;
      }
      if (![2, 3].includes(setsA + setsB)) {
        highlightScoreError("Nie wygląda to na wynik 2:0 ani 2:1. Sprawdź liczbę wygranych setów.");
        return;
      }

      const teamA = teams.find(t => t.id === currentMatch.teamAId);
      const teamB = teams.find(t => t.id === currentMatch.teamBId);
      if (!teamA || !teamB) return;

      let totalPointsA = 0;
      let totalPointsB = 0;
      currentMatch.setsHistory.forEach(set => {
        totalPointsA += set.a;
        totalPointsB += set.b;
      });

      teamA.played += 1;
      teamB.played += 1;

      if (setsA > setsB) {
        teamA.won += 1;
        teamB.lost += 1;
      } else {
        teamB.won += 1;
        teamA.lost += 1;
      }

      teamA.setsWon += setsA;
      teamA.setsLost += setsB;
      teamB.setsWon += setsB;
      teamB.setsLost += setsA;

      teamA.pointsFor += totalPointsA;
      teamA.pointsAgainst += totalPointsB;
      teamB.pointsFor += totalPointsB;
      teamB.pointsAgainst += totalPointsA;

      if (setsA === 2 && setsB === 0) {
        teamA.tablePoints += 3;
      } else if (setsA === 2 && setsB === 1) {
        teamA.tablePoints += 2;
        teamB.tablePoints += 1;
      } else if (setsB === 2 && setsA === 0) {
        teamB.tablePoints += 3;
      } else if (setsB === 2 && setsA === 1) {
        teamB.tablePoints += 2;
        teamA.tablePoints += 1;
      }

      matchesHistory.push({
        teamAId: teamA.id,
        teamBId: teamB.id,
        setsA,
        setsB,
        pointsA: totalPointsA,
        pointsB: totalPointsB,
        stage: "group",
        setsHistory: [...currentMatch.setsHistory]
      });

      currentMatch = { ...createEmptyMatch(), teamAId: teamA.id, teamBId: teamB.id };
      lastPointWinner = null;

      renderScoreboard();
      renderStandings();
      renderBreakResults();
      saveState();
    }

    function resetTournament() {
      if (!confirm("Na pewno chcesz wyczyścić całą tabelę? Nie da się cofnąć.")) return;
      resetTeamsStatsOnly();
      matchesHistory = [];
      currentMatch = createEmptyMatch();
      lastPointWinner = null;
      populateTeamSelects();
      renderScoreboard();
      renderStandings();
      renderBreakResults();
      saveState();
    }

    function renderScoreboard() {
      const teamANameEl = document.getElementById("teamAName");
      const teamBNameEl = document.getElementById("teamBName");
      const teamASetsEl = document.getElementById("teamASets");
      const teamBSetsEl = document.getElementById("teamBSets");
      const teamAPointsEl = document.getElementById("teamAPoints");
      const teamBPointsEl = document.getElementById("teamBPoints");
      const matchLabelEl = document.getElementById("matchLabel");
      const currentSetEl = document.getElementById("currentSet");
      const historyEl = document.getElementById("setsHistory");

      const teamA = teams.find(t => t.id === currentMatch.teamAId);
      const teamB = teams.find(t => t.id === currentMatch.teamBId);

      teamANameEl.textContent = teamA ? teamA.name : "Drużyna A";
      teamBNameEl.textContent = teamB ? teamB.name : "Drużyna B";

      teamASetsEl.textContent = currentMatch.setA;
      teamBSetsEl.textContent = currentMatch.setB;
      teamAPointsEl.textContent = currentMatch.pointsA;
      teamBPointsEl.textContent = currentMatch.pointsB;

      matchLabelEl.textContent = (teamA && teamB) ? `${teamA.name} vs ${teamB.name}` : "–";
      currentSetEl.textContent = currentMatch.currentSet;

      if (historyEl) {
        historyEl.innerHTML = "";
        currentMatch.setsHistory.forEach(set => {
          const chip = document.createElement("div");
          chip.className = "set-chip";
          chip.innerHTML = `<span class="set-label">Set ${set.number}:</span>${set.a} : ${set.b}`;
          historyEl.appendChild(chip);
        });
      }

      const serveA = document.getElementById("serveA");
      const serveB = document.getElementById("serveB");
      const teamANameBox = document.getElementById("teamANameBox");
      const teamBNameBox = document.getElementById("teamBNameBox");

      serveA.classList.remove("active");
      serveB.classList.remove("active");
      teamANameBox.classList.remove("serving");
      teamBNameBox.classList.remove("serving");

      if (lastPointWinner === "A") {
        serveA.classList.add("active");
        teamANameBox.classList.add("serving");
      } else if (lastPointWinner === "B") {
        serveB.classList.add("active");
        teamBNameBox.classList.add("serving");
      }

      updateControlsAvailability();
    }

    function renderBreakResults() {
      const container = document.getElementById("breakResults");
      if (!container) return;

      if (matchesHistory.length === 0) {
        container.innerHTML = '<div class="small-text">Brak zakończonych meczów.</div>';
        return;
      }

      container.innerHTML = "";
      const history = [...matchesHistory].slice().reverse();
      history.forEach(match => {
        const teamA = teams.find(t => t.id === match.teamAId);
        const teamB = teams.find(t => t.id === match.teamBId);
        const nameA = teamA ? teamA.name : "Drużyna A";
        const nameB = teamB ? teamB.name : "Drużyna B";

        const stageLabel = match.stage && match.stage !== "group"
          ? ` (${match.stage})`
          : "";

        const row = document.createElement("div");
        row.className = "break-results-item";
        row.innerHTML = `<span>${nameA} vs ${nameB}${stageLabel}</span><span>${match.setsA}:${match.setsB}</span>`;
        container.appendChild(row);
      });
    }

    function getHeadToHeadWinner(teamId1, teamId2) {
      const relevantMatches = matchesHistory.filter(
        m =>
          (!m.stage || m.stage === "group") &&
          (
            (m.teamAId === teamId1 && m.teamBId === teamId2) ||
            (m.teamAId === teamId2 && m.teamBId === teamId1)
          )
      );
      if (relevantMatches.length === 0) return null;

      let wins1 = 0, wins2 = 0;
      relevantMatches.forEach(m => {
        if (m.setsA > m.setsB) {
          if (m.teamAId === teamId1) wins1++; else wins2++;
        } else if (m.setsB > m.setsA) {
          if (m.teamBId === teamId1) wins1++; else wins2++;
        }
      });

      if (wins1 > wins2) return teamId1;
      if (wins2 > wins1) return teamId2;
      return null;
    }

    function compareTeams(a, b) {
      if (b.tablePoints !== a.tablePoints) return b.tablePoints - a.tablePoints;

      const h2hWinner = getHeadToHeadWinner(a.id, b.id);
      if (h2hWinner === a.id) return -1;
      if (h2hWinner === b.id) return 1;

      const diffA = a.setsWon - a.setsLost;
      const diffB = b.setsWon - b.setsLost;
      if (diffB !== diffA) return diffB - diffA;

      const ratioA = a.pointsAgainst === 0 ? a.pointsFor : a.pointsFor / a.pointsAgainst;
      const ratioB = b.pointsAgainst === 0 ? b.pointsFor : b.pointsFor / b.pointsAgainst;
      if (ratioB !== ratioA) return ratioB - ratioA;

      return a.name.localeCompare(b.name, "pl");
    }

    function renderStandingsForGroup(groupKey, tbodyId) {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = "";

      const groupTeams = teams
        .filter(t => (t.group || "").toUpperCase() === groupKey)
        .sort(compareTeams);

      if (!groupTeams.length) {
        const row = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 10;
        td.textContent = "Brak drużyn w tej grupie.";
        td.style.textAlign = "center";
        row.appendChild(td);
        tbody.appendChild(row);
        return;
      }

      groupTeams.forEach((team, index) => {
        const row = document.createElement("tr");

        const posTd = document.createElement("td");
        posTd.textContent = index + 1;
        row.appendChild(posTd);

        const nameTd = document.createElement("td");
        nameTd.textContent = team.name;
        nameTd.classList.add("team-name-cell");
        row.appendChild(nameTd);

        const playedTd = document.createElement("td");
        playedTd.textContent = team.played;
        row.appendChild(playedTd);

        const wonTd = document.createElement("td");
        wonTd.textContent = team.won;
        row.appendChild(wonTd);

        const lostTd = document.createElement("td");
        lostTd.textContent = team.lost;
        row.appendChild(lostTd);

        const setsWonTd = document.createElement("td");
        setsWonTd.textContent = team.setsWon;
        row.appendChild(setsWonTd);

        const setsLostTd = document.createElement("td");
        setsLostTd.textContent = team.setsLost;
        row.appendChild(setsLostTd);

        const pointsForTd = document.createElement("td");
        pointsForTd.textContent = team.pointsFor;
        row.appendChild(pointsForTd);

        const pointsAgainstTd = document.createElement("td");
        pointsAgainstTd.textContent = team.pointsAgainst;
        row.appendChild(pointsAgainstTd);

        const tablePointsTd = document.createElement("td");
        tablePointsTd.textContent = team.tablePoints;
        row.appendChild(tablePointsTd);

        tbody.appendChild(row);
      });
    }

    function renderStandings() {
      renderStandingsForGroup("A", "standingsBodyA");
      renderStandingsForGroup("B", "standingsBodyB");
      renderStandingsForGroup("C", "standingsBodyC");
      renderStandingsForGroup("D", "standingsBodyD");
    }

    function getNextTeamId() {
      if (teams.length === 0) return 0;
      return Math.max(...teams.map(t => t.id)) + 1;
    }

    function saveEditedTeamName() {
      const editTeamSelect = document.getElementById("editTeamSelect");
      const input = document.getElementById("editTeamNameInput");
      if (!editTeamSelect || !input) return;

      const id = parseInt(editTeamSelect.value, 10);
      const newName = input.value.trim();
      if (!newName) {
        alert("Podaj nową nazwę drużyny.");
        return;
      }

      const team = teams.find(t => t.id === id);
      if (!team) return;

      team.name = newName;

      if (currentMatch.teamAId === id || currentMatch.teamBId === id) {
        renderScoreboard();
      }

      populateTeamSelects();
      renderStandings();
      renderBreakResults();
      saveState();
      input.value = "";
    }

    function addTeam() {
      const input = document.getElementById("newTeamNameInput");
      if (!input) return;

      const name = input.value.trim();
      if (!name) {
        alert("Podaj nazwę nowej drużyny.");
        return;
      }

      const id = getNextTeamId();
      teams.push({
        id,
        name,
        played: 0,
        won: 0,
        lost: 0,
        setsWon: 0,
        setsLost: 0,
        pointsFor: 0,
        pointsAgainst: 0,
        tablePoints: 0,
        group: ""
      });

      populateTeamSelects();
      renderStandings();
      renderBreakResults();
      saveState();
      input.value = "";
    }

    // DODAWANIE MECZU RĘCZNIE – SET PO SECIE
    function addManualMatch() {
      const manualTeamA = document.getElementById("manualTeamA");
      const manualTeamB = document.getElementById("manualTeamB");

      const s1A = parseInt(document.getElementById("manualSet1A").value, 10);
      const s1B = parseInt(document.getElementById("manualSet1B").value, 10);
      const s2A = parseInt(document.getElementById("manualSet2A").value, 10);
      const s2B = parseInt(document.getElementById("manualSet2B").value, 10);
      const s3Araw = document.getElementById("manualSet3A").value;
      const s3Braw = document.getElementById("manualSet3B").value;
      const s3A = s3Araw === "" ? null : parseInt(s3Araw, 10);
      const s3B = s3Braw === "" ? null : parseInt(s3Braw, 10);

      const stageSelect = document.getElementById("manualStage");

      if (!manualTeamA || !manualTeamB) return;

      const teamAId = parseInt(manualTeamA.value, 10);
      const teamBId = parseInt(manualTeamB.value, 10);

      if (teamAId === teamBId) {
        alert("Wybierz dwie różne drużyny.");
        return;
      }

      if (Number.isNaN(s1A) || Number.isNaN(s1B) || Number.isNaN(s2A) || Number.isNaN(s2B)) {
        alert("Podaj wyniki co najmniej dwóch setów.");
        return;
      }

      const sets = [
        { a: s1A, b: s1B },
        { a: s2A, b: s2B }
      ];

      if (s3A !== null && s3B !== null && !Number.isNaN(s3A) && !Number.isNaN(s3B)) {
        sets.push({ a: s3A, b: s3B });
      }

      const setsCount = sets.length;
      if (setsCount < 2 || setsCount > 3) {
        alert("Mecz musi mieć 2 albo 3 sety.");
        return;
      }

      let setsA = 0;
      let setsB = 0;
      let totalPointsA = 0;
      let totalPointsB = 0;

      for (const s of sets) {
        if (s.a > s.b) setsA++;
        else if (s.b > s.a) setsB++;
        else {
          alert("Set nie może zakończyć się remisem.");
          return;
        }
        totalPointsA += s.a;
        totalPointsB += s.b;
      }

      if (!((setsA === 2 && setsB <= 1) || (setsB === 2 && setsA <= 1))) {
        alert("Dozwolone wyniki meczu: 2:0, 2:1, 1:2, 0:2.");
        return;
      }

      if ((setsA + setsB) !== setsCount || ![2,3].includes(setsA + setsB)) {
        alert("Coś nie gra z liczbą wygranych setów – sprawdź wyniki.");
        return;
      }

      const teamA = teams.find(t => t.id === teamAId);
      const teamB = teams.find(t => t.id === teamBId);
      if (!teamA || !teamB) {
        alert("Nie znaleziono jednej z drużyn.");
        return;
      }

      const stage = stageSelect ? stageSelect.value : "group";

      const affectsStandings = stage === "group";

      if (affectsStandings) {
        teamA.played += 1;
      teamB.played += 1;

      if (setsA > setsB) {
        teamA.won += 1;
        teamB.lost += 1;
      } else {
        teamB.won += 1;
        teamA.lost += 1;
      }

      teamA.setsWon += setsA;
      teamA.setsLost += setsB;
      teamB.setsWon += setsB;
      teamB.setsLost += setsA;

      teamA.pointsFor += totalPointsA;
      teamA.pointsAgainst += totalPointsB;
      teamB.pointsFor += totalPointsB;
      teamB.pointsAgainst += totalPointsA;

      if (setsA === 2 && setsB === 0) {
        teamA.tablePoints += 3;
      } else if (setsA === 2 && setsB === 1) {
        teamA.tablePoints += 2;
        teamB.tablePoints += 1;
      } else if (setsB === 2 && setsA === 0) {
        teamB.tablePoints += 3;
      } else if (setsB === 2 && setsA === 1) {
        teamB.tablePoints += 2;
        teamA.tablePoints += 1;
      }

            }

      matchesHistory.push({
        teamAId: teamA.id,
        teamBId: teamB.id,
        setsA,
        setsB,
        pointsA: totalPointsA,
        pointsB: totalPointsB,
        stage,
        manual: true,
        setsHistory: sets.map((s, i) => ({
          number: i + 1,
          a: s.a,
          b: s.b
        }))
      });

      renderStandings();
      renderBreakResults();
      saveState();

      document.getElementById("manualSet1A").value = "";
      document.getElementById("manualSet1B").value = "";
      document.getElementById("manualSet2A").value = "";
      document.getElementById("manualSet2B").value = "";
      document.getElementById("manualSet3A").value = "";
      document.getElementById("manualSet3B").value = "";

      alert("Mecz został dodany do tabeli.");
    }

    function attachEvents() {
      const startBtn = document.getElementById("startMatchBtn");
      const swapBtn = document.getElementById("swapTeamsBtn");
      const resetTournamentBtn = document.getElementById("resetTournamentBtn");

      if (startBtn) startBtn.addEventListener("click", startOrResetMatch);
      if (swapBtn) swapBtn.addEventListener("click", swapTeams);
      if (resetTournamentBtn) resetTournamentBtn.addEventListener("click", resetTournament);

      document.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");
          if (action === "addPointA") updatePoints("A", 1);
          if (action === "subPointA") updatePoints("A", -1);
          if (action === "addPointB") updatePoints("B", 1);
          if (action === "subPointB") updatePoints("B", -1);
        });
      });

      const endSetABtn = document.getElementById("endSetABtn");
      const endSetBBtn = document.getElementById("endSetBBtn");
      const resetSetBtn = document.getElementById("resetSetBtn");
      const finishMatchABtn = document.getElementById("finishMatchABtn");
      const finishMatchBBtn = document.getElementById("finishMatchBBtn");

      if (endSetABtn) endSetABtn.addEventListener("click", () => endSet("A"));
      if (endSetBBtn) endSetBBtn.addEventListener("click", () => endSet("B"));
      if (resetSetBtn) resetSetBtn.addEventListener("click", resetCurrentSet);
      if (finishMatchABtn) finishMatchABtn.addEventListener("click", () => finishMatch("A"));
      if (finishMatchBBtn) finishMatchBBtn.addEventListener("click", () => finishMatch("B"));

      const saveTeamNameBtn = document.getElementById("saveTeamNameBtn");
      const addTeamBtn = document.getElementById("addTeamBtn");
      if (saveTeamNameBtn) saveTeamNameBtn.addEventListener("click", saveEditedTeamName);
      if (addTeamBtn) addTeamBtn.addEventListener("click", addTeam);

      const addSponsorBtn = document.getElementById("addSponsorBtn");
      if (addSponsorBtn) addSponsorBtn.addEventListener("click", addSponsor);

      const applySceneBtn = document.getElementById("applySceneBtn");
      const sceneSelect = document.getElementById("sceneSelect");
      if (applySceneBtn && sceneSelect) {
        applySceneBtn.addEventListener("click", () => {
          setScene(sceneSelect.value);
        });
      }

      const addManualMatchBtn = document.getElementById("addManualMatchBtn");
      if (addManualMatchBtn) {
        addManualMatchBtn.addEventListener("click", addManualMatch);
      }
    }


    function attachKeyboardShortcuts() {
      // Only in control/panel modes (not overlay scenes)
      if (viewMode === "overlay") return;

      window.addEventListener("keydown", (e) => {
        // Don't hijack typing in inputs
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : "";
        if (["INPUT", "SELECT", "TEXTAREA"].includes(tag)) return;

        // Avoid accidental repeats when holding a key
        if (e.repeat) return;

        const key = (e.key || "").toLowerCase();

        // Q/W -> Team A (+/-), O/P -> Team B (+/-)
        if (key === "q") { e.preventDefault(); updatePoints("A", 1); return; }
        if (key === "w") { e.preventDefault(); updatePoints("A", -1); return; }
        if (key === "o") { e.preventDefault(); updatePoints("B", 1); return; }
        if (key === "p") { e.preventDefault(); updatePoints("B", -1); return; }

        // Optional: Enter ends the set for last point winner (if you want)
        // if (key === "enter" && lastPointWinner) { endSet(lastPointWinner); }
      });
    }

    /* ---- START ---- */

    initTeams();
    const hasState = loadState();
    populateTeamSelects();
    attachEvents();
    attachKeyboardShortcuts();
    renderSponsorsList();
    startSponsorsRotation();

    if (!hasState) {
      const teamASelect = document.getElementById("teamASelect");
      const teamBSelect = document.getElementById("teamBSelect");
      if (teamASelect && teamBSelect && teams.length >= 2) {
        teamASelect.value = teams[0].id;
        teamBSelect.value = teams[1].id;
        startOrResetMatch();
      }
      renderStandings();
    } else {
      renderScoreboard();
      renderStandings();
    }

    renderBreakResults();
    applySceneToDOM();

    if (viewMode === "overlay") {
      detectLogoFiles(startOverlayLogoRotation);
      detectOrganizerFiles(startOrganizerRotation);
    }

    window.addEventListener("storage", (event) => {
      if (event.key !== STORAGE_KEY) return;
      const ok = loadState();
      if (!ok) return;
      renderScoreboard();
      renderStandings();
      renderBreakResults();
      renderSponsorsList();
      renderSponsorsBar();
      applySceneToDOM();
    });
  </script>
</body>
</html>